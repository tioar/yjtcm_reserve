<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>永濟中醫診所線上預約</title>
<style>
:root{
  --brand:#2e7dba; --brand-600:#25689b;
  --ink:#142033; --muted:#5d6b7c;
  --bg:#f5f8fc; --card:#fff; --line:#e6eef7;
  --early-bg:#e7f7ee; --early-bd:#bfead7; --early-tx:#085e42;
  --noon-bg:#fff3df;  --noon-bd:#ffd89e; --noon-tx:#7a4d00;
  --night-bg:#e8f2ff; --night-bd:#cfe2ff; --night-tx:#1d4ed8;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif}
.container{max-width:1100px;margin:18px auto;padding:0 14px}
.h1{display:flex;align-items:center;gap:10px;font-weight:900;font-size:clamp(22px,4.2vw,32px)}
.badge{background:var(--brand);color:#fff;border-radius:50%;width:42px;height:42px;display:grid;place-items:center;font-weight:900}

.section{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;margin-top:14px}
.tt{font-weight:900;margin:6px 2px 10px}

/* doctor chips */
.filters{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid #d9e6f3;border-radius:999px;background:#fff;padding:.48rem .95rem;font-weight:800;cursor:pointer}
.chip[aria-pressed="true"]{background:#e7f1fb;border-color:#cfe4fb;color:#14508a}

/* calendar */
.grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.wd{color:var(--muted);text-align:center;font-weight:800}
.day{min-height:84px;background:#fff;border:1px solid #e6e8f0;border-radius:12px;display:flex;flex-direction:column;gap:6px;padding:8px}
.day .d{font-weight:900}
.day.clickable{cursor:pointer}
.day.clickable:hover{box-shadow:0 0 0 2px #cfe2ff}
.day.today{background:#2e3440;color:#fff;border-color:#2e3440}
.day.today .d{color:#fff}

.pill{display:inline-block;border-radius:999px;border:1px solid #e3e6ee;padding:.1rem .5rem;font-weight:900;font-size:.78rem}
.pill.early{background:var(--early-bg);border-color:var(--early-bd);color:var(--early-tx)}
.pill.noon {background:var(--noon-bg); border-color:var(--noon-bd); color:var(--noon-tx)}
.pill.night{background:var(--night-bg);border-color:var(--night-bd);color:var(--night-tx)}

/* slot group (doctor -> session) */
.slot{border:1px solid #e0e4ef;border-radius:12px;padding:12px;background:#fff;display:flex;gap:10px;align-items:center}
.slot:hover{box-shadow:0 0 0 2px #e6f1ff}
.slot .remain{margin-left:auto;color:#475569}
.slot + .caps{margin:8px 0 14px 0;display:flex;flex-wrap:wrap;gap:8px}
.caps button{border:1px solid #d7dcea;background:#fff;border-radius:999px;padding:.5rem .8rem;font-weight:800;cursor:pointer}
.caps button[aria-pressed="true"]{background:#e8f1ff;border-color:#bdd6ff}

/* form */
.form{display:grid;gap:12px}
.input{border:1px solid #d3dbea;border-radius:12px;height:46px;padding:0 .9rem;background:#fff}
.btn{border:none;border-radius:12px;padding:1rem 1.2rem;font-weight:900;cursor:pointer}
.btn-main{background:var(--brand);color:#fff}
.btn-main:hover{background:var(--brand-600)}
.btn-ghost{background:#fff;border:1px solid #d7e3f2;color:#1f4f82}

/* chosen summary card */
.chosen{border:1px dashed #c7d6ea;border-radius:14px;background:#fbfdff;padding:12px;font-weight:800;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.chosen .tag{border:1px solid #cfe4fb;border-radius:999px;padding:.35rem .7rem;background:#fff}
.note{color:#5d6b7c;font-size:.92rem}
</style>
</head>
<body>
<div class="container">
  <div class="h1"><div class="badge">＋</div> 預約（DEMO C：先選醫師／15 分鐘）</div>

  <!-- 醫師（可複選） -->
  <div class="section">
    <div class="tt">請先選擇醫師（可複選）</div>
    <div class="filters" id="docFilters"></div>
    <div class="note">提示：若不挑醫師，可同時勾選多位，系統會顯示任一勾選醫師可預約的日期。</div>
  </div>

  <!-- 月曆 & 時段 -->
  <div class="section" id="calSec">
    <div class="tt" id="calTitle">可預約日</div>
    <div class="grid7" id="wdRow"></div>
    <div class="grid7" id="days"></div>
    <div class="tt" style="margin-top:12px">當日可預約（醫師 → 時段 → 15 分鐘）</div>
    <div id="slotGroups" style="display:grid;gap:12px"></div>
  </div>

  <!-- 已選卡片 + 表單 -->
  <div class="section">
    <div class="tt">已選擇</div>
    <div id="chosen" class="chosen">尚未選擇</div>

    <div class="form" style="margin-top:12px">
      <input id="name" class="input" placeholder="姓名 *"/>
      <input id="birthday" class="input" type="date" placeholder="出生年月日 *"/>
      <input id="idnum" class="input" maxlength="10" placeholder="身分證字號 *"/>
      <input id="phone" class="input" maxlength="10" inputmode="numeric" placeholder="聯絡電話 *"/>
      <label><input type="checkbox" id="agree"/> 我已閱讀並同意預約須知</label>
      <button class="btn btn-main" id="submit">送出預約</button>
      <button class="btn btn-ghost" onclick="alert('Demo：查詢/取消')">查詢/取消預約</button>
    </div>
  </div>
</div>

<script>
/* === 假資料（兩位醫師，一時段只會有一位醫師在看） === */
const DOCTORS=[
  {id:'chenTCM', name:'江玉梅醫師'},
  {id:'tsaiTCM', name:'游志聰醫師'},
];

/* 結構：SLOTS[doctorId][date] = [{slot:'early|noon|night', label:'早診', start:'08:30', end:'11:30', remain:7}] */
const SLOTS={
  'chenTCM':{
    '2025-09-27':[ {slot:'early',label:'早診', start:'08:30', end:'11:30', remain:6} ],
    '2025-09-30':[ {slot:'noon', label:'午診', start:'14:00', end:'17:00', remain:9} ],
  },
  'tsaiTCM':{
    '2025-09-28':[ {slot:'night',label:'晚診', start:'18:00', end:'20:30', remain:8} ],
    '2025-10-01':[ {slot:'early',label:'早診', start:'09:00', end:'12:00', remain:10} ],
  }
};

const W=['日','一','二','三','四','五','六'];
const NOW=new Date(); const TODAY=ymd(NOW);
const $=s=>document.querySelector(s);
const $docFilters=$('#docFilters'), $wd=$('#wdRow'), $days=$('#days'), $groups=$('#slotGroups');

/* 狀態（支援多醫師） */
const state={
  doctors:new Set(),   // 多選
  date:null,           // YYYY-MM-DD
  chosen:null          // {doctorId, date, start, end, no, label}
};

/* ---- utils ---- */
function pad2(n){return String(n).padStart(2,'0')}
function ymd(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`}
function firstOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1)}
function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0)}
function toMin(hhmm){const [h,m]=hhmm.split(':').map(Number); return h*60+m}
function minToHHMM(min){const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`}
function between15Slots(start,end){ // 15 分鐘切片（含起點，不含終點）
  const s=toMin(start), e=toMin(end); const out=[];
  for(let t=s, i=0; t<e; t+=15, i++){ out.push({start:minToHHMM(t), no:i+1}); }
  return out;
}
function formatROC(dateStr){ // YYYY-MM-DD -> YYYY/MM/DD（週X）
  const [y,m,d]=dateStr.split('-').map(Number);
  const dt=new Date(y, m-1, d);
  return `${y}/${pad2(m)}/${pad2(d)}（週${W[dt.getDay()]}）`;
}

/* ---- render: doctors (multi-select) ---- */
function renderDoctorChips(){
  $docFilters.innerHTML='';
  DOCTORS.forEach(doc=>{
    const b=document.createElement('button');
    b.type='button'; b.className='chip'; b.textContent=doc.name;
    if(state.doctors.has(doc.id)) b.setAttribute('aria-pressed','true');
    b.onclick=()=>{
      if(state.doctors.has(doc.id)) state.doctors.delete(doc.id);
      else state.doctors.add(doc.id);
      // 重選醫師後，清掉日期與選擇
      state.date=null; state.chosen=null;
      renderDoctorChips(); renderCalendar(); renderGroups(); renderChosen();
    };
    $docFilters.appendChild(b);
  });
}

/* ---- render: calendar ---- */
function renderCalendar(){
  $wd.innerHTML = W.map(w=>`<div class="wd">${w}</div>`).join('');
  const m=firstOfMonth(NOW), first=firstOfMonth(m), last=endOfMonth(m);
  const pad=first.getDay();
  let html='';
  for(let i=0;i<pad;i++) html+=`<div></div>`;
  for(let d=1; d<=last.getDate(); d++){
    const cur=new Date(first.getFullYear(),first.getMonth(),d);
    const key=ymd(cur);
    const isToday=(key===TODAY);
    // 只要任一已選醫師有這天就可點
    let has=false;
    if(state.doctors.size>0){
      for(const docId of state.doctors){ if(SLOTS[docId]?.[key]) { has=true; break; } }
    }
    const cls='day'+(has?' clickable':'')+(isToday?' today':'');
    // 顯示最多兩個時段膠囊預覽
    let meta='—';
    if(has){
      const firstDocId=[...state.doctors].find(id=>SLOTS[id]?.[key]);
      const pills=(SLOTS[firstDocId][key]||[]).slice(0,2).map(s=>`<span class="pill ${s.slot}">${s.label}</span>`).join(' ');
      meta=pills || '—';
    }
    html+=`<div class="${cls}" data-ymd="${key}"><div class="d">${d}</div><div class="meta">${meta}</div></div>`;
  }
  $days.innerHTML=html;
  $days.querySelectorAll('.day.clickable').forEach(el=>{
    el.onclick=()=>{ $days.querySelectorAll('.day').forEach(x=>x.style.outline='none'); el.style.outline='2px solid #b9dafb'; state.date=el.dataset.ymd; state.chosen=null; renderGroups(); renderChosen(); };
  });
}

/* ---- render: per-day groups (doctor -> session -> 15-min capsules) ---- */
function renderGroups(){
  $groups.innerHTML='';
  if(!state.date || state.doctors.size===0){
    $groups.innerHTML='<div class="note">請先勾選醫師，並點選可預約日期。</div>';
    return;
  }
  // 遍歷已選醫師
  [...state.doctors].forEach(docId=>{
    const doc=DOCTORS.find(d=>d.id===docId);
    const sessions=SLOTS[docId]?.[state.date] || [];
    sessions.forEach((s, idx)=>{
      const row=document.createElement('div');
      row.className='slot';
      row.innerHTML=`<strong>${doc.name}</strong> <span class="pill ${s.slot}">${s.label}</span> ${s.start}~${s.end} <span class="remain">剩 ${s.remain} 人</span>`;
      const caps=document.createElement('div'); caps.className='caps';
      const times=between15Slots(s.start, s.end); // 15 分鐘切片
      times.forEach(t=>{
        const btn=document.createElement('button');
        btn.type='button';
        btn.textContent=t.start;
        btn.dataset.doctor=docId;
        btn.dataset.date=state.date;
        btn.dataset.start=t.start;
        btn.dataset.end=minToHHMM(toMin(t.start)+15);
        btn.dataset.no=t.no;
        btn.onclick=()=>{
          // 清除此 group 內標記
          caps.querySelectorAll('button').forEach(b=>b.removeAttribute('aria-pressed'));
          btn.setAttribute('aria-pressed','true');
          state.chosen={
            doctorId:docId,
            date:state.date,
            start:btn.dataset.start,
            end:btn.dataset.end,
            no:Number(btn.dataset.no),
            label:s.label
          };
          renderChosen();
        };
        caps.appendChild(btn);
      });
      $groups.appendChild(row);
      $groups.appendChild(caps);
    });
  });

  // 若當天沒有任一班別
  if(!$groups.children.length){
    $groups.innerHTML='<div class="note">當日無可預約時段（或該日非所選醫師門診）。</div>';
  }
}

/* ---- render: chosen summary ---- */
function renderChosen(){
  const box=$('#chosen');
  const name=$('#name').value.trim();
  if(!state.chosen){
    box.textContent='尚未選擇';
    return;
  }
  const doc=DOCTORS.find(d=>d.id===state.chosen.doctorId)?.name||'';
  box.innerHTML='';
  const items=[
    {t:'日期',v:formatROC(state.chosen.date)},
    {t:'時間',v:`${state.chosen.start}~${state.chosen.end}（${state.chosen.label}）`},
    {t:'幾號',v:`第 ${state.chosen.no} 號`},
    {t:'醫師',v:doc},
    {t:'姓名',v:name||'（尚未填寫）'}
  ];
  items.forEach(it=>{
    const span=document.createElement('span');
    span.className='tag';
    span.textContent=`${it.t}：${it.v}`;
    box.appendChild(span);
  });
}

/* ---- submit (demo) ---- */
$('#submit').onclick=()=>{
  const ok = $('#name').value.trim() && $('#birthday').value && $('#idnum').value.trim()
            && $('#phone').value.trim() && $('#agree').checked && state.chosen;
  if(!ok){ alert('資料或選擇未完成'); return; }
  // 這裡帶回必要欄位（示意）
  const payload={
    doctorId:state.chosen.doctorId,
    date:state.chosen.date,
    start:state.chosen.start,
    end:state.chosen.end,
    no:state.chosen.no,
    name:$('#name').value.trim(),
    birthday:$('#birthday').value,
    idnum:$('#idnum').value.trim(),
    phone:$('#phone').value.trim()
  };
  console.log('submit payload', payload);
  alert(`Demo：送出成功\n${JSON.stringify(payload,null,2)}`);
};

/* ---- events: keep chosen card synced with name ---- */
$('#name').addEventListener('input', renderChosen);

/* ---- boot ---- */
function boot(){
  renderDoctorChips();
  // calendar frame
  $('#calTitle').textContent='可預約日';
  $wd.innerHTML = W.map(w=>`<div class="wd">${w}</div>`).join('');
  renderCalendar();
  renderGroups();
  renderChosen();
}
boot();
</script>
</body>
</html>
