<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>永濟中醫診所｜線上預約</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#efe7dd;        /* 淡米底 */
  --card:#fff;
  --ink:#3b2f28;
  --muted:#7b6d63;
  --line:#e8dfd6;

  --slot-early:#ad7b67; /* 你的色盤 */
  --slot-noon: #a0a295;
  --slot-night:#577483;

  --pill-fg:#fff;
  --disabled:#e9e0d6;

  --accent:#6b4b2d;    /* 選中強化 */
  --accent-weak:#cdb49e;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Serif TC","Noto Sans TC","Microsoft JhengHei",serif}
.wrap{max-width:980px;margin:14px auto;padding:10px}

/* head */
.head{display:flex;align-items:end;justify-content:space-between;gap:10px;margin-bottom:8px}
.h-left{display:flex;align-items:center;gap:12px}
.h-month{font-size:clamp(24px,4.2vw,34px);font-weight:900}
.h-range{color:var(--muted);font-weight:700}
.btn{border:1px solid #cdb49e;background:#f7f0e8;border-radius:10px;padding:.4rem .8rem;cursor:pointer}
.btn[disabled]{opacity:.4;cursor:not-allowed}

/* doctor filter */
.doctors{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 4px}
.chip{padding:.5rem 1rem;border:1px solid #d8cabc;background:#f4ece5;border-radius:10px;font-weight:800;cursor:pointer}
.chip[aria-pressed="true"]{background:#e9dccf;border-color:#cdb49e}
.note{color:var(--muted);font-size:.95rem;margin:.2rem 0 .8rem}

/* grid */
.grid7{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px}
.wd{color:var(--muted);text-align:center;font-weight:800}
.day{min-height:86px;border:1px solid var(--line);border-radius:12px;background:#f7efe6;display:flex;flex-direction:column;gap:6px;padding:8px;position:relative}
.day .d{font-weight:900}
.meta{margin-top:auto;display:flex;gap:6px;flex-wrap:wrap}
.day.clickable{background:#fff;cursor:pointer}
.day.disabled{background:var(--disabled);color:#a09286}
.day.selected{outline:3px solid var(--accent);box-shadow:0 0 0 2px var(--accent-weak) inset}

/* pills（方塊）*/
.pill{display:inline-flex;align-items:center;justify-content:center;font-weight:900;padding:.2rem .5rem;border-radius:6px;border:1px solid #d8cabc;color:var(--pill-fg);white-space:nowrap}
.pill.early{background:var(--slot-early)}
.pill.noon {background:var(--slot-noon)}
.pill.night{background:var(--slot-night)}
.pill.off{opacity:.45}

/* calendar loader chip */
.cal-loader{position:fixed;left:50%;transform:translateX(-50%);top:90px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:.5rem .8rem;display:none;align-items:center;gap:.6rem;box-shadow:0 8px 20px rgba(0,0,0,.08)}
.spin{
  width:18px;height:18px;border:3px solid #e5d8c8;border-top-color:#6d5a48;border-radius:50%;
  animation:rot 0.8s linear infinite
}
@keyframes rot{to{transform:rotate(360deg)}}

/* sections */
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:10px}

/* day list (accordion) */
.acc{display:grid;gap:8px;margin-top:6px}
.acc-item{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
.acc-h{display:flex;align-items:center;justify-content:space-between;padding:.7rem .9rem;cursor:pointer}
.acc-h .left{display:flex;gap:.6rem;align-items:center}
.badge{border-radius:6px;padding:.12rem .5rem;color:#fff;font-weight:900}
.badge.early{background:var(--slot-early)} .badge.noon{background:var(--slot-noon)} .badge.night{background:var(--slot-night)}
.rem{color:var(--muted);font-weight:800}
.chev{color:var(--muted);font-weight:900}
.acc-body{display:none;padding:.8rem .9rem;border-top:1px solid var(--line);background:#f9f3ec}
.time-grid{display:flex;flex-wrap:wrap;gap:8px}
.time{padding:.4rem .7rem;border:1px solid #d8cabc;border-radius:9px;background:#ead5c3;cursor:pointer;font-weight:800}
.time.disabled{opacity:.45;cursor:not-allowed}
.acc-item.full .acc-h{opacity:.55;cursor:default}

/* picked summary（單行） */
.pick{background:#fff4e3;border:1px solid #e9d1b5;border-radius:12px;padding:.7rem .9rem;font-weight:800}

/* small */
@media (max-width:640px){
  .grid7{gap:6px}
  .day{min-height:70px}
  .pill{padding:.16rem .4rem}
  .h-month{font-size:22px}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- 醫師（單選；預設皆可） -->
  <div class="card">
    <div class="doctors" id="docRow"></div>
    <div class="note">載入時月曆僅顯示日期；成功載入後一次顯示診別方塊。</div>
  </div>

  <!-- 月曆 -->
  <div class="card">
    <div class="head">
      <div class="h-left">
        <div class="h-month" id="bigMonth">—</div>
        <div class="h-range" id="rangeText">—</div>
      </div>
      <div class="h-right">
        <button class="btn" id="prevBtn">上個月</button>
        <button class="btn" id="nextBtn">下個月</button>
      </div>
    </div>

    <div class="grid7" id="wdRow"></div>
    <div class="grid7" id="days"></div>
  </div>

  <!-- 當日清單（手風琴） -->
  <div class="card" id="dayPanel" style="display:none">
    <div id="dayTitle" style="font-weight:900;margin-bottom:6px">—</div>
    <div class="acc" id="acc"></div>
  </div>

  <!-- 已選擇（單行摘要） -->
  <div class="card" id="summary" style="display:none">
    <div class="pick" id="pickLine"></div>
  </div>
</div>

<!-- calendar chip-loader -->
<div class="cal-loader" id="calLoader">
  <div class="spin"></div>
  <div id="calText">載入中…</div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbz4DkAoRThUXiy8wnhfZyBdEcCmh7Za9QZ3F1D4-vFvOH7cAQMUFRLKHAE0AX0gfhO8/exec'; // 例如：https://script.google.com/macros/s/xxxx/exec

/* ====== 基本工具 ====== */
const $=s=>document.querySelector(s);
const pad2=n=>String(n).padStart(2,'0');
const ymd=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const firstOfMonth=d=>new Date(d.getFullYear(),d.getMonth(),1);
const endOfMonth=d=>new Date(d.getFullYear(),d.getMonth()+1,0);
const addMonths=(d,n)=>new Date(d.getFullYear(),d.getMonth()+n,1);
const W=['日','一','二','三','四','五','六'];

/* ====== 狀態 ====== */
let INIT=null;               // {range:{start,end}, doctors:[...]}
let curMonth=null;           // 目前月首
let MIN_DATE=null, MAX_DATE=null;  // D+2 ~ D+14（可能跨月）
let doctorSel='ALL';         // 皆可 / 指定醫師
let monthCache={};           // { 'YYYY-MM': { days:{'YYYY-MM-DD':{early:n,noon:n,night:n}} } }
let picked=null;             // {date,label,range,time,doctor,no}

/* ====== DOM ====== */
const $wdRow=$('#wdRow'), $days=$('#days');
const $bigMonth=$('#bigMonth'), $rangeText=$('#rangeText');
const $prev=$('#prevBtn'), $next=$('#nextBtn');
const $loader=$('#calLoader'), $calText=$('#calText');
const $dayPanel=$('#dayPanel'), $dayTitle=$('#dayTitle'), $acc=$('#acc');
const $summary=$('#summary'), $pickLine=$('#pickLine');

/* 星期列 */
$wdRow.innerHTML=W.map(w=>`<div class="wd">${w}</div>`).join('');

/* 醫師單選 */
function renderDoctors(){
  const row=$('#docRow'); row.innerHTML='';
  const allBtn=document.createElement('button');
  allBtn.className='chip'; allBtn.textContent='皆可'; allBtn.type='button';
  allBtn.setAttribute('aria-pressed', doctorSel==='ALL' ? 'true':'false');
  allBtn.onclick=()=>{doctorSel='ALL'; renderDoctors(); bootMonth(curMonth);}
  row.appendChild(allBtn);

  (INIT.doctors||[]).forEach(name=>{
    const b=document.createElement('button');
    b.className='chip'; b.textContent=name; b.type='button';
    b.setAttribute('aria-pressed', doctorSel===name ? 'true':'false');
    b.onclick=()=>{doctorSel=name; renderDoctors(); bootMonth(curMonth);}
    row.appendChild(b);
  });
}

/* 標題、切月限制 */
function updateHeader(){
  $bigMonth.textContent = `${curMonth.getFullYear()}年${curMonth.getMonth()+1}月份`;
  const s=new Date(MIN_DATE), e=new Date(MAX_DATE);
  const sStr=`${s.getFullYear()}/${pad2(s.getMonth()+1)}/${pad2(s.getDate())}（週${W[s.getDay()]}）`;
  const eStr=`${e.getFullYear()}/${pad2(e.getMonth()+1)}/${pad2(e.getDate())}（週${W[e.getDay()]}）`;
  $rangeText.textContent=`可預約日：${sStr} ～ ${eStr}`;

  const minMonth=firstOfMonth(MIN_DATE), maxMonth=firstOfMonth(MAX_DATE);
  $prev.disabled = (curMonth.getTime()<=minMonth.getTime());
  $next.disabled = (curMonth.getTime()>=maxMonth.getTime());
}

/* 月曆骨架（不顯示診別） */
function skeleton(monthDate){
  const first=firstOfMonth(monthDate), last=endOfMonth(monthDate);
  let html=''; const pad=first.getDay();
  for(let i=0;i<pad;i++) html+=`<div></div>`;
  for(let d=1; d<=last.getDate(); d++){
    const cur=new Date(first.getFullYear(),first.getMonth(),d);
    const key=ymd(cur);
    const inWindow = (cur>=MIN_DATE && cur<=MAX_DATE);
    let cls='day'+(inWindow?' clickable':' disabled');
    html+=`<div class="${cls}" data-ymd="${key}"><div class="d">${d}</div><div class="meta" data-meta="1"></div></div>`;
  }
  $days.innerHTML=html;

  // 只有可點的才掛 click
  $days.querySelectorAll('.day.clickable').forEach(el=>{
    el.addEventListener('click',()=>{ selectDay(el.dataset.ymd); });
  });
}

/* 顯示卡片 Loader */
function showCalLoader(on, txt){
  if(on){ $calText.textContent=txt||'載入中…'; $loader.style.display='flex'; }
  else { $loader.style.display='none'; }
}

/* 取月資料（快取） */
async function loadMonth(monthDate){
  const key=`${monthDate.getFullYear()}-${pad2(monthDate.getMonth()+1)}`;
  if(monthCache[key]) return monthCache[key];
  const start=ymd(firstOfMonth(monthDate)), end=ymd(endOfMonth(monthDate));
  const doctors = (doctorSel==='ALL') ? (INIT.doctors||[]) : [doctorSel];

  // 顯示進度
  showCalLoader(true, '載入中…');

  const r = await fetch(`${API_URL}?action=summary&start=${start}&end=${end}&doctors=${encodeURIComponent(doctors.join(','))}`);
  const data=await r.json();
  showCalLoader(false);
  monthCache[key]=data; return data;
}

/* 將診別塞進月曆（載入成功後才補） */
function hydrate(monthDate, dayMap){
  $days.querySelectorAll('.day').forEach(el=>{
    const key=el.dataset.ymd; const meta=dayMap[key];
    const box=el.querySelector('[data-meta]');
    if(!box) return;
    if(!meta){ box.innerHTML=''; return; }

    const pills=[];
    if(meta.early!==undefined) pills.push(`<span class="pill early ${meta.early>0?'':'off'}">早診</span>`);
    if(meta.noon !==undefined) pills.push(`<span class="pill noon  ${meta.noon >0?'':'off'}">午診</span>`);
    if(meta.night!==undefined) pills.push(`<span class="pill night ${meta.night>0?'':'off'}">晚診</span>`);
    box.innerHTML=pills.join('');
  });
}

/* 點日 → 開手風琴 */
async function selectDay(dateYMD){
  $days.querySelectorAll('.day').forEach(d=>d.classList.remove('selected'));
  const el=$days.querySelector(`.day[data-ymd="${dateYMD}"]`);
  if(el) el.classList.add('selected');

  const docs=(doctorSel==='ALL')?(INIT.doctors||[]):[doctorSel];
  $dayTitle.textContent=`當日可預約（醫師 → 診別 → 15 分鐘）`;
  $acc.innerHTML='';
  $dayPanel.style.display='block';

  showCalLoader(true, '載入中…');

  const r = await fetch(`${API_URL}?action=slots&date=${dateYMD}&doctors=${encodeURIComponent(docs.join(','))}`);
  const data=await r.json();
  showCalLoader(false);

  const groups = Array.isArray(data?.groups)?data.groups:[];
  if(!groups.length){ $acc.innerHTML='<div style="color:#8b7e74">請先選擇日期。</div>'; return; }

  // 只顯示一次展開；額滿不可展開
  groups.forEach((g,i)=>{
    const key = (g.label.includes('早'))?'early':(g.label.includes('午')?'noon':'night');
    const item=document.createElement('div');
    item.className='acc-item'+(g.remain>0?'':' full');
    const hdr=`<div class="acc-h">
      <div class="left">
        <span class="badge ${key}">${g.label}</span>
        <div style="font-weight:900">${g.doctor}</div>
        <div style="color:#7b6d63"> ${g.range}</div>
      </div>
      <div class="right">
        <span class="rem">${g.remain>0?`剩 ${g.remain} 位`:'已額滿'}</span>
        <span class="chev">▾</span>
      </div>
    </div>`;
    const body=document.createElement('div');
    body.className='acc-body';
    const tgrid=document.createElement('div');
    tgrid.className='time-grid';

    (g.capsules||[]).forEach(c=>{
      const b=document.createElement('button');
      b.className='time';
      b.textContent=c.time;
      b.onclick=()=>{
        picked={date:dateYMD,label:g.label,range:g.range,time:c.time,doctor:g.doctor,no:c.no};
        renderPicked();
      };
      tgrid.appendChild(b);
    });
    body.appendChild(tgrid);
    item.innerHTML=hdr; item.appendChild(body); $acc.appendChild(item);

    if(g.remain>0){
      item.querySelector('.acc-h').onclick=()=>{
        $acc.querySelectorAll('.acc-body').forEach(b=>b.style.display='none');
        if(body.style.display==='block'){ body.style.display='none'; }
        else{ body.style.display='block'; }
      };
    }
  });
}

/* 已選擇行（單行） */
function renderPicked(){
  if(!picked){ $summary.style.display='none'; return; }
  const w = new Date(picked.date).getDay();
  const line =
    `日期：${picked.date}（週${'日一二三四五六'[w]}）　`+
    `時間：${picked.time}（${picked.label}｜${picked.range}）　`+
    `醫師：${picked.doctor}　`+
    `第幾號：第 ${picked.no} 號　`+
    `姓名：（尚未填寫）`;
  $pickLine.textContent=line;
  $summary.style.display='block';
}

/* 啟動整月 */
async function bootMonth(monthDate){
  curMonth=firstOfMonth(monthDate);
  updateHeader();
  skeleton(curMonth);
  const data=await loadMonth(curMonth);
  hydrate(curMonth, data.days||{});
}

/* ====== 初始化 ====== */
(async function init(){
  try{
    const r=await fetch(`${API_URL}?action=init`);
    INIT=await r.json();
    // D+2～D+14
    MIN_DATE=new Date(INIT.range.start);
    MAX_DATE=new Date(INIT.range.end);
    curMonth=firstOfMonth(new Date()); // 預設本月

    renderDoctors();
    updateHeader();
    await bootMonth(curMonth);

    // 切月（限制本月/下月，依視窗自動判斷）
    $prev.onclick=()=>{ if(!$prev.disabled) bootMonth(addMonths(curMonth,-1)); };
    $next.onclick=()=>{ if(!$next.disabled) bootMonth(addMonths(curMonth, 1)); };
  }catch(err){
    console.error(err);
    alert('初始化失敗，請稍後再試');
  }
})();
</script>
</body>
</html>
