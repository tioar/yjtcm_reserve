<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>永濟中醫診所｜線上預約</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#efe5da; --card:#fff; --line:#e0d4c7; --ink:#2a231b; --muted:#6f6a62;
  /* 診別色：早/午/晚 */
  --early:#4f7f65; --noon:#b77a2a; --night:#3f6674;
  --brand:#6b5844;
  --slot-bd:#cbb7a2;
  --sel-bg:#d9b99a; --sel-bd:#b88f6a;
  --today:#a8927a;
  --disabled-bg:#ececec; --disabled-ink:#8f949d;

  /* 已選卡片用的淡底（同色系） */
  --early-tint:#e9f1ec;
  --noon-tint:#f8efe3;
  --night-tint:#e7eef1;

  /* 停診標籤（棗紅/酒紅調，明顯） */
  --closed:#e60000;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Serif TC","Source Han Serif TC",serif}
a,button{color:inherit;text-decoration:none;font-family:"Noto Serif TC","Source Han Serif TC",serif}

/* 容器 */
.container{max-width:880px;margin:18px auto;padding:0 14px}
@media (max-width:600px){ .container{max-width:100%} }

/* 標題 */
.h1{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:900;font-size:clamp(26px,4.8vw,40px);color:var(--brand)}
.badge{background:var(--brand);color:#fff;border-radius:10px;width:42px;height:42px;display:grid;place-items:center;font-weight:900}

.section{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;margin-top:14px}
.tt{font-weight:900;margin:6px 2px 10px;color:var(--brand)}
.note{color:var(--muted);font-size:.92rem}

/* = 月曆頭 = */
.cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:12px}
.cal-left{display:flex;align-items:center;gap:12px}
.cal-title{font-weight:900;color:var(--brand);font-size:clamp(18px,3.4vw,24px)}
.today-text{color:#a47b55;font-weight:800}
.nav{display:flex;gap:8px;margin-left:auto}
.nav .arrow{width:36px;height:36px;border:1px solid var(--line);border-radius:10px;background:#fff;display:grid;place-items:center;cursor:pointer}
.nav .arrow:disabled{opacity:.35;cursor:not-allowed}
.nav .arrow.prev::before,
.nav .arrow.next::before{content:"";display:block;width:10px;height:10px;border-right:2px solid #7b6b58;border-bottom:2px solid #7b6b58}
.nav .arrow.prev::before{transform:rotate(135deg)}
.nav .arrow.next::before{transform:rotate(-45deg)}

/* 月曆本體 */
.cal-wrap{position:relative}
.grid7{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px}
.wd{color:#8b8379;text-align:center;font-weight:800;font-size:.88rem}

.day{
  min-height:92px;background:#fff;border:1px solid var(--line);border-radius:10px;
  display:flex;flex-direction:column;align-items:center;gap:6px;padding:6px;
  transition:background .12s,border-color .12s,box-shadow .12s;overflow:hidden
}
.day.clickable{cursor:pointer}
.day.off{background:#f3ede6;color:#9a948b}
.day.today{background:var(--today);color:#fff;border-color:var(--today)}
.day.disabled{background:var(--disabled-bg);color:var(--disabled-ink)}
.day.today.disabled{background:#d3cdc6;color:#5b5b5b;border-color:#c5bdb5}
.day.selected{background:var(--sel-bg);border-color:var(--sel-bd);box-shadow:0 0 0 2px var(--sel-bd)}
.day .d{font-weight:900;font-size:1rem}
.meta{text-align:center;min-height:58px;display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:flex-start}
/* 不可預約的日子：一般標籤灰化；停診標籤保持紅色與不透明 */
.day.disabled .blk{filter:grayscale(100%);opacity:.55}
.day.disabled .blk.closed{filter:none;opacity:1}

.expired{color:#9a948b;background:#eee;border:1px solid #e0d4c7;border-radius:999px;padding:2px 8px;font-size:.78rem;font-weight:900}

/* 標籤 */
.blk{display:inline-block;border-radius:8px;padding:3px 9px;font-size:.78rem;font-weight:900;color:#fff;line-height:1}
.blk.early{background:var(--early)} .blk.noon{background:var(--noon)} .blk.night{background:var(--night)}
.blk.closed{background:var(--closed);color:#fff;border:1px solid #b30000;box-shadow:0 0 0 2px rgba(230,0,0,.06)}

/* 覆蓋月曆的轉圈圈 */
#calLoading{
  position:absolute; inset:44px 12px 12px 12px; display:none;
  align-items:center; justify-content:center;
  background:rgba(239,229,218,.6); backdrop-filter:blur(1px); border-radius:10px;
}
.cal-wrap.loading #calLoading{display:flex}
.loader{display:flex;gap:12px;align-items:center;border:1px solid var(--line);background:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);font-weight:800;color:var(--brand)}
.spin{width:22px;height:22px;border:3px solid #e8dccc;border-top-color:#5a4a3a;border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}

/* 手風琴 + slots */
.acc-item{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
.acc-head{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer}
.acc-head .doc{font-weight:900}
.acc-head .tag{padding:3px 10px;color:#fff;border-radius:8px;font-weight:900}
.acc-head .tag.early{background:var(--early)} .acc-head .tag.noon{background:var(--noon)} .acc-head .tag.night{background:var(--night)}
.acc-head .range,.acc-head .remain{color:#5a5248}
.acc-head .remain{margin-left:auto}
.acc-head .chev{width:10px;height:10px;border-right:2px solid #7b6b58;border-bottom:2px solid #7b6b58;transform:rotate(-45deg);transition:.18s}
.acc-item.open .acc-head{background:#faf5ef}
.acc-item.open .acc-head .chev{transform:rotate(45deg)}
.acc-body{display:none;padding:0 14px 12px 14px}
.acc-item.open .acc-body{display:block}

.caps{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
.slot{border:1px solid var(--slot-bd);background:#fff;border-radius:10px;padding:.55rem 1rem;font-weight:800;cursor:pointer}
.slot[aria-pressed="true"].early{background:var(--early);color:#fff;border-color:var(--early)}
.slot[aria-pressed="true"].noon{background:var(--noon);color:#fff;border-color:var(--noon)}
.slot[aria-pressed="true"].night{background:var(--night);color:#fff;border-color:var(--night)}
.slot.disabled{background:var(--disabled-bg);color:var(--disabled-ink);border-color:#ddd;cursor:not-allowed;pointer-events:none}

/* slots 的小載入條 */
#slotGroups{position:relative;display:grid;gap:10px}
#slotGroups.loading{min-height:44px}
#slotLoading{display:none;position:relative;margin:8px 0}
#slotGroups.loading #slotLoading{display:flex}
.mini-loader{display:flex;gap:10px;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:12px;font-weight:800;color:var(--brand)}
.mini-spin{width:16px;height:16px;border:3px solid #e8dccc;border-top-color:#5a4a3a;border-radius:50%;animation:sp .8s linear infinite}

/* 表單 & 已選卡片（淡底黑字） */
.chosen{
  border:1px dashed #d9c9b6;background:#faf5ef;padding:12px;border-radius:12px;
  font-weight:800; box-shadow:0 2px 8px rgba(0,0,0,.06); transition:.15s
}
.chosen.solid{border-style:solid;color:#111}
.chosen.solid.early{background:var(--early-tint);border-color:var(--early)}
.chosen.solid.noon {background:var(--noon-tint); border-color:var(--noon)}
.chosen.solid.night{background:var(--night-tint);border-color:var(--night)}
.chosen .sub{opacity:.85}

.form{display:grid;gap:12px}
.label{font-weight:900;margin-bottom:6px;color:#3f362c}
.input{border:1px solid var(--line);border-radius:10px;height:46px;padding:0 .9rem;background:#fff;width:100%}

.btn-stack{display:grid;gap:10px}
.filter{border:1px solid var(--line);border-radius:12px;background:#fff;padding:.60rem .95rem;font-weight:900;cursor:pointer;font-size:1.02rem;text-align:center}
.btn-solid{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-ghost{background:#fff;color:var(--brand);border-color:var(--brand)}

@media (max-width:600px){
  .container{padding:0 8px}
  .grid7{gap:4px}
  .day{min-height:76px;padding:6px}
  .meta{min-height:44px}
  .blk{padding:2px 6px;font-size:.78rem}
}
</style>
</head>
<body>
<div class="container">
  <div class="h1"><div class="badge">＋</div> 永濟中醫診所｜線上預約</div>

  <div class="section cal-wrap" id="calWrap">
    <div class="cal-head">
      <div class="cal-left">
        <div class="cal-title" id="calTitle">—</div>
        <div class="today-text" id="todayText">—</div>
      </div>
      <div class="nav">
        <button id="btnPrev" class="arrow prev" title="上個月"></button>
        <button id="btnNext" class="arrow next" title="下個月"></button>
      </div>
    </div>

    <div class="tt" id="rangeNote">可預約日</div>
    <div class="grid7" id="wdRow"></div>
    <div class="grid7" id="days"></div>

    <!-- 覆蓋月曆的轉圈圈 -->
    <div id="calLoading">
      <div class="loader"><div class="spin"></div>載入中</div>
    </div>

    <div class="tt" style="margin-top:12px">當日可預約（醫師 → 診別 → 15 分鐘）</div>
    <div id="slotGroups">
      <div id="slotLoading" class="mini-loader"><div class="mini-spin"></div>載入中</div>
    </div>
  </div>

  <div class="section">
    <div class="tt">已選擇</div>
    <div id="chosen" class="chosen">尚未選擇</div>

    <div class="form" style="margin-top:12px">
      <div>
        <div class="label">姓名 *</div>
        <input id="name" class="input" placeholder="請輸入姓名" autocomplete="off"/>
      </div>
      <div>
        <div class="label">出生年月日 *</div>
        <input id="birthday" class="input" type="date" placeholder="YYYY-MM-DD"/>
      </div>
      <div>
        <div class="label">身分證字號 *</div>
        <input id="idnum" class="input" maxlength="10" placeholder="A123456789" autocomplete="off"/>
      </div>
      <div>
        <div class="label">聯絡電話 *</div>
        <input id="phone" class="input" maxlength="10" inputmode="numeric" placeholder="09xxxxxxxx" autocomplete="off"/>
      </div>

      <label><input type="checkbox" id="agree"/> 我已閱讀並同意預約須知</label>

      <div class="btn-stack">
        <button class="filter btn-solid" id="submit">送出預約</button>
        <!-- 直接以連結前往查詢頁（方形小圓角；與首頁風格一致） -->
        <a href="query.html" class="filter btn-ghost" id="btnQuery">查詢 / 取消預約</a>
      </div>
    </div>
  </div>
</div>

<script>
/* 你的 GAS 網址（提供 init / summary / slots / reserve）*/
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzHMD1jFXowpT3jxc6PdPmD0PnrDE_xSYdM_4_iLf1mqU9uEZLDHiL0-_bi5zQm8Tt9/exec';

const W=['日','一','二','三','四','五','六'];
const $=s=>document.querySelector(s);
const $wd=$('#wdRow'), $days=$('#days'), $groups=$('#slotGroups'), $calWrap=$('#calWrap');
const todayStr = ymd(new Date());

/* 前端簡易快取 + 中止控制（避免重複拉資料） */
const cache={ summary:new Map(), slots:new Map(), init:null };
let monthCtrl=null, slotsCtrl=null;

/* 狀態 */
const state={
  doctorsMaster:[],
  range:null,
  date:null,
  monthSummary:{},
  curMonth:firstOfMonth(new Date())
};

/* Utils */
function pad2(n){return String(n).padStart(2,'0')}
function ymd(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`}
function firstOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1)}
function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0)}
function fmtROC(dateStr){const [y,m,d]=dateStr.split('-').map(Number);const dt=new Date(y,m-1,d);return `${y}/${pad2(m)}/${pad2(d)}（${W[dt.getDay()]}）`}
function todayLabel(){ const now=new Date(); return `${now.getMonth()+1}月${now.getDate()}日（${W[now.getDay()]}）`; }

/* 覆蓋式月曆 loading */
function calLoading(on){ $calWrap.classList.toggle('loading', !!on); }

/* API（含快取/中止） */
async function api(action, params={}){
  const key = action+':'+JSON.stringify(params);
  if(action==='summary' && cache.summary.has(key)) return cache.summary.get(key);
  if(action==='slots'   && cache.slots.has(key))   return cache.slots.get(key);
  if(action==='init'    && cache.init)             return cache.init;

  const url=new URL(SCRIPT_URL);
  url.searchParams.set('action',action);
  for(const [k,v] of Object.entries(params)){
    url.searchParams.set(k, Array.isArray(v)? v.join(',') : v);
  }

  let controller=null;
  if(action==='summary'){ if(monthCtrl) monthCtrl.abort(); controller = monthCtrl = new AbortController(); }
  else if(action==='slots'){ if(slotsCtrl) slotsCtrl.abort(); controller = slotsCtrl = new AbortController(); }
  else{ controller = new AbortController(); }

  const r=await fetch(url.toString(),{ signal: controller.signal, cache:'no-store' });
  if(!r.ok) throw new Error('network');
  const data=await r.json();

  if(action==='summary') cache.summary.set(key,data);
  if(action==='slots')   cache.slots.set(key,data);
  if(action==='init')    cache.init = data;
  return data;
}

/* Boot */
async function boot(){
  $wd.innerHTML=W.map(w=>`<div class="wd">${w}</div>`).join('');
  updateCalHead(); drawCalendarShell();

  calLoading(true);
  try{
    const conf = await api('init');
    state.range = conf.range;
    state.doctorsMaster = conf.doctors||[];
    $('#rangeNote').textContent = `可預約日：${fmtROC(conf.range.start)} ～ ${fmtROC(conf.range.end)}`;
  }finally{ calLoading(false); }

  await loadMonthSummary();
  prefetchNextMonth();
  fillDiagnoses();
}

/* 抬頭 + 箭頭 */
function updateCalHead(){
  const f = state.curMonth;
  $('#calTitle').textContent = `${f.getFullYear()}年${f.getMonth()+1}月份`;
  $('#todayText').textContent = todayLabel();

  const nowFirst = firstOfMonth(new Date());
  const nextFirst = firstOfMonth(new Date(nowFirst.getFullYear(), nowFirst.getMonth()+1, 1));
  $('#btnPrev').disabled = f.getTime()<=nowFirst.getTime();
  $('#btnNext').disabled = f.getTime()>=nextFirst.getTime();
}

/* 月殼 */
function drawCalendarShell(){
  const first = state.curMonth, last=endOfMonth(first), pad=first.getDay();
  let html=''; for(let i=0;i<pad;i++) html+=`<div class="day"></div>`;
  for(let d=1; d<=last.getDate(); d++){
    const key=ymd(new Date(first.getFullYear(),first.getMonth(),d));
    const isToday=(key===todayStr);
    const isPast=(key<todayStr);
    const cls=['day']; if(isPast) cls.push('off'); if(isToday) cls.push('today');
    html+=`<div class="${cls.join(' ')}" data-ymd="${key}">
      <div class="d">${d}</div>
      <div class="meta"></div>
    </div>`;
  }
  $days.innerHTML=html;
}

/* 整月摘要 */
async function loadMonthSummary(){
  calLoading(true);
  try{
    const start=ymd(state.curMonth), end=ymd(endOfMonth(state.curMonth));
    const data=await api('summary',{start,end,doctors:state.doctorsMaster});
    state.monthSummary = data.days||{};
  } finally { calLoading(false); }
}

/* 預抓下一個月 */
function prefetchNextMonth(){
  const cur = state.curMonth;
  const next = new Date(cur.getFullYear(), cur.getMonth()+1, 1);
  const start=ymd(next), end=ymd(endOfMonth(next));
  api('summary',{start,end,doctors:state.doctorsMaster}).catch(()=>{});
}

/* 填標籤（含停診） */
function fillDiagnoses(){
  const inRange = state.range;
  $days.querySelectorAll('.day').forEach(el=>{
    const key=el.dataset.ymd, meta=el.querySelector('.meta'); if(!meta) return;
    meta.innerHTML='';

    const s = state.monthSummary[key] || {};

    if(s.closed){
      const span=document.createElement('span');
      span.className='blk closed';
      span.textContent='停診';
      if(s.note) span.title=s.note;
      meta.appendChild(span);
      el.classList.remove('clickable'); el.classList.add('disabled'); el.onclick=null;
      return;
    }

    if(key < todayStr){
      const expired=document.createElement('div');
      expired.className='expired'; expired.textContent='已過期';
      meta.appendChild(expired);
      el.classList.remove('clickable','disabled'); el.onclick=null;
      return;
    }

    if(s.early!==undefined){ const sp=document.createElement('span'); sp.className='blk early'; sp.textContent='早診'; meta.appendChild(sp); }
    if(s.noon !==undefined){ const sp=document.createElement('span'); sp.className='blk noon';  sp.textContent='午診'; meta.appendChild(sp); }
    if(s.night!==undefined){ const sp=document.createElement('span'); sp.className='blk night'; sp.textContent='晚診'; meta.appendChild(sp); }

    const clickable = inRange && key>=inRange.start && key<=inRange.end;
    el.classList.toggle('clickable', clickable);
    el.classList.toggle('disabled', !clickable);
    if(clickable){
      el.onclick=()=>{ $days.querySelectorAll('.day').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected'); state.date=key; state.chosen=null; renderGroups(); renderChosen(); };
    }else{ el.onclick=null; }
  });
}

/* 當日手風琴 */
async function renderGroups(){
  $groups.classList.add('loading');
  $groups.querySelectorAll('.acc-item, .note').forEach(n=>n.remove());
  try{
    if(!state.date){
      const note=document.createElement('div'); note.className='note'; note.textContent='請點選可預約的日期。';
      $groups.appendChild(note); return;
    }
    const res=await api('slots',{date:state.date, doctors:state.doctorsMaster});
    if(res.closed){
      const note=document.createElement('div'); note.className='note';
      note.textContent = `本日停診${res.note? '（'+res.note+'）':''}。`;
      $groups.appendChild(note); return;
    }
    if(!res.groups.length){
      const note=document.createElement('div'); note.className='note';
      note.textContent='當日無可預約時段或已額滿。';
      $groups.appendChild(note); return;
    }

    res.groups.forEach(g=>{
      const key = g.label.includes('早')?'early':(g.label.includes('午')?'noon':'night');
      const item=document.createElement('div'); item.className='acc-item';

      const head=document.createElement('div'); head.className='acc-head';
      head.innerHTML=`<span class="tag ${key}">${g.label}</span>
                      <span class="doc">${g.doctor}</span>
                      <span class="range">${g.range}</span>
                      <span class="remain">剩 ${g.remain} 位</span>
                      <span class="chev"></span>`;
      item.appendChild(head);

      const body=document.createElement('div'); body.className='acc-body';
      const caps=document.createElement('div'); caps.className='caps';

      const ava=new Set((g.capsules||[]).map(c=>c.time));
      const [start,end] = g.range.replace(/\s+/g,'').split('～');
      for(const t of timeSlices(start,end,15)){
        const btn=document.createElement('button'); btn.type='button'; btn.textContent=t;
        btn.className = `slot ${key}`;
        const isAvail = ava.has(t);
        if(!isAvail){ btn.classList.add('disabled'); }
        else{
          btn.onclick=()=>{ $groups.querySelectorAll('.slot[aria-pressed="true"]').forEach(b=>b.removeAttribute('aria-pressed'));
            btn.setAttribute('aria-pressed','true');
            const obj=(g.capsules||[]).find(c=>c.time===t)||{};
            state.chosen={doctor:g.doctor,date:state.date,label:g.label,range:g.range,time:t,no:obj.no};
            renderChosen();
          };
        }
        caps.appendChild(btn);
      }

      body.appendChild(caps); item.appendChild(body);
      head.onclick=()=>{ const opening=!item.classList.contains('open'); $groups.querySelectorAll('.acc-item.open').forEach(x=>x.classList.remove('open')); if(opening) item.classList.add('open'); };
      $groups.appendChild(item);
    });
  } finally {
    $groups.classList.remove('loading');
  }
}

/* 切 15 分鐘 */
function* timeSlices(start,end,stepMin=15){
  const [sh,sm]=start.split(':').map(Number), [eh,em]=end.split(':').map(Number);
  let t=sh*60+sm, E=eh*60+em;
  while(t<E){ const h=pad2(Math.floor(t/60)), m=pad2(t%60); yield `${h}:${m}`; t+=stepMin; }
}

/* 已選摘要：淡色卡＋黑字 */
function renderChosen(){
  const box=$('#chosen');
  box.classList.remove('solid','early','noon','night');
  if(!state.chosen){ box.textContent='尚未選擇'; return; }

  const key = state.chosen.label.includes('早')?'early':(state.chosen.label.includes('午')?'noon':'night');
  box.classList.add('solid', key);
  box.innerHTML = `${fmtROC(state.chosen.date)}　時間：<b>${state.chosen.time}</b>（${state.chosen.label}｜${state.chosen.range}）　<span class="sub">${state.chosen.doctor}</span>`;
}

/* 送出（GET） */
$('#submit').onclick=async ()=>{
  const req={
    name:$('#name').value.trim(),
    birthday:$('#birthday').value,
    idnum:$('#idnum').value.trim().toUpperCase(),
    phone:$('#phone').value.trim(),
    agree:$('#agree').checked ? '1':'0',
    chosen: state.chosen ? JSON.stringify(state.chosen) : ''
  };
  if(!(req.name && req.birthday && req.idnum && req.phone && req.agree==='1' && state.chosen)){
    alert('資料或選擇未完成'); return;
  }
  if(!/^[A-Z][12]\d{8}$/.test(req.idnum)){ alert('身分證格式或檢查碼錯誤'); return; }
  const d=new Date(req.birthday); if(Number.isNaN(+d) || d.getTime()>Date.now()){ alert('生日超出限制'); return; }

  const url=new URL(SCRIPT_URL);
  url.searchParams.set('action','reserve');
  Object.entries(req).forEach(([k,v])=>url.searchParams.set(k,v));
  const r=await fetch(url.toString());
  const data=await r.json();
  if(data.ok){ alert(`預約成功！\n您的號碼：第 ${data.no} 號`); }
  else{ alert(`預約失敗：${data.msg||'未知錯誤'}`); }

  await loadMonthSummary(); fillDiagnoses(); renderGroups();
};

/* 身分證英文自動大寫；電話只允許數字 */
$('#idnum').addEventListener('input',e=>{
  const p=e.target.selectionStart;
  e.target.value=e.target.value.toUpperCase();
  try{ e.target.setSelectionRange(p,p);}catch(_){}
});
$('#phone').addEventListener('input',e=>{
  const p=e.target.selectionStart;
  const cleaned = String(e.target.value).replace(/\D/g,'').slice(0,10);
  e.target.value = cleaned;
  try{ const pos = Math.min(p, cleaned.length); e.target.setSelectionRange(pos, pos);}catch(_){}
});

/* 月份切換（本月/下月） */
$('#btnPrev').addEventListener('click', async()=>{
  state.curMonth = firstOfMonth(new Date(state.curMonth.getFullYear(), state.curMonth.getMonth()-1, 1));
  updateCalHead(); drawCalendarShell(); await loadMonthSummary(); fillDiagnoses(); state.date=null; renderGroups(); renderChosen();
});
$('#btnNext').addEventListener('click', async()=>{
  state.curMonth = firstOfMonth(new Date(state.curMonth.getFullYear(), state.curMonth.getMonth()+1, 1));
  updateCalHead(); drawCalendarShell(); await loadMonthSummary(); prefetchNextMonth(); fillDiagnoses(); state.date=null; renderGroups(); renderChosen();
});

/* 啟動 */
boot().catch(err=>{ console.error(err); alert('初始化失敗，請稍後再試'); });
</script>
</body>
</html>
