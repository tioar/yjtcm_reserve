<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>永濟中醫診所｜查詢／取消預約</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#6b5844; --brand-600:#5a4a3a;
  --card:#fff; --bg:#efe5da; --line:#e0d4c7; --ink:#2a231b;
  --early:#e9f1ec; --noon:#f8efe3; --night:#e7eef1;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Serif TC","Source Han Serif TC",serif}
.wrap{max-width:880px;margin:18px auto;padding:0 14px}
.h1{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:900;font-size:clamp(26px,4.8vw,40px);color:var(--brand)}
.badge{background:var(--brand);color:#fff;border-radius:10px;width:42px;height:42px;display:grid;place-items:center;font-weight:900}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}

/* 表單與按鈕（方形小圓角，與首頁一致） */
.label{font-weight:900;margin:8px 0 6px;color:#3f362c}
.input{border:1px solid var(--line);border-radius:10px;height:46px;padding:0 .9rem;background:#fff;width:100%;font-size:16px}
.btn{
  border-radius:12px;                        /* 這裡改成小圓角 */
  font-weight:900;
  padding:.60rem .95rem;
  font-size:1.02rem;
  cursor:pointer;
  border:1px solid var(--line);
}
.btn-main{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-ghost{background:#fff;color:var(--brand);border-color:var(--brand)}
.btn-danger{background:#dc3545;color:#fff;border-color:#dc3545}
.btn[disabled]{opacity:.5;cursor:not-allowed}

/* 結果表頭 + 列 */
.head, .row{display:grid;grid-template-columns:1.1fr .8fr 1.2fr 1fr 1fr .6fr .7fr;gap:.6rem;align-items:center}
.head{font-weight:900;color:#3f362c;margin:12px 0}
.row{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
.row.early{background:var(--early)}
.row.noon {background:var(--noon)}
.row.night{background:var(--night)}
.meta{color:#6f6a62;font-size:.92rem;margin:8px 0}

/* 遮罩 + 轉圈圈 */
#mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;gap:12px;z-index:9999;background:rgba(255,255,255,.9);backdrop-filter:blur(2px);color:var(--brand-600);font-weight:900}
.spin{width:26px;height:26px;border:3px solid #eadfd2;border-top-color:var(--brand-600);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
@media (max-width:640px){
  .head,.row{grid-template-columns:1fr .8fr 1.2fr .9fr 1fr .6fr .7fr;font-size:14px}
}
</style>
</head>
<body>
<div id="mask"><div class="spin"></div><span id="maskText">查詢中</span></div>

<div class="wrap">
  <div class="h1"><div class="badge">＋</div> 查詢／取消預約</div>

  <div class="card">
    <div class="label">身分證字號</div>
    <input id="pid" class="input" maxlength="10" placeholder="例如：A123456789" autocomplete="off">
    <div style="display:grid;gap:10px;margin-top:12px">
      <button id="btnQuery" class="btn btn-main">查詢</button>
      <a href="index.html" class="btn btn-ghost" style="text-align:center;text-decoration:none">返回預約首頁</a>
    </div>

    <div id="result" style="display:none">
      <div class="head" style="margin-top:18px">
        <div>預約日期</div><div>診別</div><div>時段</div><div>醫師</div><div>姓名</div><div>號碼</div><div>取消</div>
      </div>
      <div id="list"></div>
      <div class="meta" id="hint" style="display:none">（僅顯示未取消的預約；當日請以電話取消）</div>
    </div>
  </div>
</div>

<script>
/* 查詢/取消的 GAS 網址（需提供 queryByPid / cancelOne 兩個 action） */
const API = "https://script.google.com/macros/s/AKfycbwj2RLuzlroVFGNNp9drzAt1nEs3aF1jXDWwYL9sNjVOw0BQgp6Rgwhl1WVeuspVqPO/exec";

/* 身分證：嚴格檢核（含檢查碼） */
function validateTaiwanId(id){
  id = String(id||'').toUpperCase();
  if(!/^[A-Z][12]\d{8}$/.test(id)) return false;
  const map={A:10,B:11,C:12,D:13,E:14,F:15,G:16,H:17,I:34,J:18,K:19,L:20,M:21,N:22,O:35,P:23,Q:24,R:25,S:26,T:27,U:28,V:29,W:32,X:30,Y:31,Z:33};
  const n = map[id[0]]; if(n===undefined) return false;
  const x=Math.floor(n/10), y=n%10, d=id.slice(1).split('').map(Number);
  const w=[8,7,6,5,4,3,2,1,1];
  let sum = 1*x + 9*y;
  for(let i=0;i<9;i++) sum += d[i]*w[i];
  return sum%10===0;
}

/* 元素 */
const $pid=document.getElementById('pid');
const $btn=document.getElementById('btnQuery');
const $res=document.getElementById('result');
const $list=document.getElementById('list');
const $hint=document.getElementById('hint');
const $mask=document.getElementById('mask');
const $maskText=document.getElementById('maskText');

/* 英文自動大寫（保留游標位置） */
$pid.addEventListener('input',e=>{
  const p=e.target.selectionStart;
  e.target.value=e.target.value.toUpperCase();
  try{ e.target.setSelectionRange(p,p); }catch(_){}
});

/* 遮罩 */
function showMask(txt){ $maskText.textContent=txt||'查詢中'; $mask.style.display='flex'; }
function hideMask(){ $mask.style.display='none'; }

/* slot → row 顏色 */
function slotKey(s){ return s.includes('早')?'early':s.includes('午')?'noon':'night'; }

/* 查詢 */
async function query(){
  const id = $pid.value.trim().toUpperCase();
  if(!validateTaiwanId(id)){ alert('請輸入正確的身分證字號'); return; }
  showMask('查詢中');
  try{
    const url=new URL(API); url.searchParams.set('action','queryByPid'); url.searchParams.set('idnum',id); url.searchParams.set('t',Date.now());
    const r=await fetch(url.toString(),{cache:'no-store'});
    const data=await r.json();
    const rows = Array.isArray(data.items)?data.items:[];
    $res.style.display='block'; $list.innerHTML='';
    if(!rows.length){ $hint.style.display='none'; $list.innerHTML='<div class="meta">查無未取消預約</div>'; return; }
    $hint.style.display='block';
    rows.forEach(item=>appendRow(item));
  }catch(err){ console.error(err); alert('查詢失敗，請稍後再試'); }
  finally{ hideMask(); }
}

/* 寫一列 */
function appendRow(item){
  const row = document.createElement('div');
  row.className = 'row '+slotKey(item.slot||'');
  const canCancel = isFutureDay(item.date);
  row.innerHTML = `
    <div>${item.date||''}</div>
    <div>${item.slot||''}</div>
    <div>${item.time||''}</div>
    <div>${item.doctor||''}</div>
    <div>${item.name||''}</div>
    <div>${item.num||''}</div>
    <div><button class="btn btn-danger" ${canCancel?'':'disabled'}>取消</button></div>
  `;
  row.querySelector('button').onclick = ()=>{ if(canCancel) cancelOne(item.row); };
  $list.appendChild(row);
}

/* 僅允許「非當日」取消 */
function isFutureDay(ymd){
  const t=new Date(); t.setHours(0,0,0,0);
  const d=new Date(ymd+'T00:00:00+08:00');
  return d.getTime()>t.getTime();
}

/* 取消單筆 */
async function cancelOne(row){
  if(!confirm('確認取消這筆預約？')) return;
  showMask('取消中');
  try{
    const url=new URL(API); url.searchParams.set('action','cancelOne'); url.searchParams.set('row',row); url.searchParams.set('t',Date.now());
    const r=await fetch(url.toString(),{cache:'no-store'});
    const data=await r.json();
    if(data && data.ok){ alert(data.message||'已取消'); await query(); }
    else{ alert((data&&data.message)||'取消失敗'); }
  }catch(err){ console.error(err); alert('取消失敗，請稍後再試'); }
  finally{ hideMask(); }
}

/* 綁事件 */
$btn.addEventListener('click',query);
$pid.addEventListener('keydown',e=>{ if(e.key==='Enter') query(); });
</script>
</body>
</html>
